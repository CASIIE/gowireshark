# Gowireshark

> Gowireshark is a Golang library that allows our Golang program to have wireshark's protocol parsing capabilities, 
> which can parse pcap packet files or listen to devices in real time and get protocol parsing results.

- Based on libpcap 1.10.1, wireshark 4.0.2
- Currently only x86-64 platform is supported
---
## 1. Installation

---
### 1.1. Requirements
- x86-64
- glib-2.0

```shell
# install glib-2.0
sudo apt install libglib2.0-dev -y
```

### 1.2. Usage

```shell
go get "github.com/randolphcyg/gowireshark"
```

how to test:

```shell
cd tests/
go test -v -run TestDissectPrintFirstFrame
```

how to dissect a pcap file:

```go
package main
   
import (
    "fmt"

    "github.com/randolphcyg/gowireshark"
)

func main() {
    filepath := "pcaps/s7comm_clean.pcap"
    err := gowireshark.DissectPrintFirstFrame(filepath)
    if err != nil {
        fmt.Println(err)
    }
}
```
Other examples can refer to the test file.

## 2. Detailed description

---

### 2.1. Project directory structure
```
gowireshark
├── README.md
├── cJSON.c
├── frame_tvbuff.c
├── go.mod
├── go.sum
├── gowireshark.go
├── include/
│   ├── cJSON.h
│   ├── frame_tvbuff.h
│   ├── lib.h
│   ├── libpcap/
│   ├── offline.h
│   ├── online.h
│   └── wireshark/
├── lib.c
├── libs/
│   ├── libpcap.so.1
│   ├── libwireshark.so
│   ├── libwireshark.so.16
│   ├── libwireshark.so.16.0.2
│   ├── libwiretap.so
│   ├── libwiretap.so.13
│   ├── libwiretap.so.13.0.2
│   ├── libwsutil.so
│   ├── libwsutil.so.14
│   └── libwsutil.so.14.0.0
├── offline.c
├── online.c
├── pcaps/
│   ├── s7comm_clean.pcap
│   └── wincc_s400_production.pcap
└── tests/
    └── gowireshark_test.go
```
Detailed description of the project directory structure：
- **include/wireshark/** wireshark compiled source code.
- **include/libpcap/** libpcap compiled source code.
- **libs/** wireshark、libpcap dll files.
- **pcaps/** pcap packet files used for testing.
- **tests/** test files.
- **cJSON.c、cJSON.h** [cJSON](https://github.com/DaveGamble/cJSON) library.
- **lib.c、offline.c、online.c** Encapsulate and strengthen libpcap and wireshark with C.
- **include/lib.h、offline.h、online.h** The declaration of the wireshark interface is encapsulated in C and finally called by the Go encapsulation.
- **gowireshark.go** All external interfaces are encapsulated by Go.

### 2.2. Call chain

```mermaid
graph LR
    A(golang)==cgo==>B(clang)
    B(clang)-.->C[wireshark dll]
    B(clang)-.->D[libpcap dll]
    style A fill:#FFCCCC
    style B fill:#99CCCC
    style C fill:#FFCC99,stroke:#FFCCCC,stroke-width:2px,stroke-dasharray: 5, 5
    style D fill:#FFCC99,stroke:#FFCCCC,stroke-width:2px,stroke-dasharray: 5, 5
```


### 2.3. How to compile wireshark, libpcap dynamic link libraries

> If the compiled wireshark and libpcap dynamic link libraries are different from the supported versions of the current project, please cover the include/wireshark and libpcap directories simultaneously;
> Note that if the wireshark version changes greatly, some interfaces in this project may be invalid, but they can be studied and fixed;


<details>
<summary>1.Compile the wireshark dynamic link library</summary>

```shell
# Operate in the /opt directory
cd /opt/

# Download the source code
wget https://1.as.dl.wireshark.org/src/wireshark-4.0.2.tar.xz

# Unzip and modify the folder name
tar -xvf wireshark-4.0.2.tar.xz
mv wireshark-4.0.2 wireshark

# Go to the wireshark directory
cd wireshark/

--------[For the first time] How to check the dependencies required for compilation-------------
# Resolve dependency issues according to the output red error log until they are ignored when a qt5 error occurs
cmake -LH ./

# If you do not have cmake3.20, please install it first
wget https://cmake.org/files/LatestRelease/cmake-3.24.2.tar.gz
sudo tar -xzf cmake-3.24.2.tar.gz
cd cmake-3.24.2/
sudo ./bootstrap
sudo apt install build-essential -y

# If openSSL is not installed, execute it
sudo apt install libssl-dev  -y
sudo make
sudo make install
cmake --version

# Dependencies that may need to be installed
apt install libgcrypt-dev -y
apt install libc-ares-dev -y
apt install flex -y
apt install libglib2.0-dev -y
apt install libssl-dev -y
apt install ninja-build -y
apt install pcaputils -y
apt install libpcap-dev -y
# Qt5-related dependencies are not used and can be ignored
apt install qtbase5-dev -y
apt install qttools5-dev-tools -y
apt install qttools5-dev -y
apt install qtmultimedia5-dev -y

# Dependent on the problem resolution complete, delete the files generated by the test
rm CMakeCache.txt
rm -rf CMakeFiles/
-------------------------------------------------------------------------------

# Create a build-specific directory under the wireshark/ directory
mkdir build
cd build

# Build [For production]
cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_wireshark=off -DENABLE_LUA=off ..

# Compile[slightly longer]
ninja

# After successful compilation, enter the run directory to view the compiled dynamic link library
cd run/
ls -lh

# Overwrites replaces the original 9 wireshark dynamic link library files
cd gowireshark/libs/
cp/opt/wireshark/build/run/lib*so* .

# Overwrite the wireshark source folder(Remove the useless build/ directory first)
rm -rf /opt/wireshark/build/
cp /opt/wireshark/ gowireshark/include/wireshark/

# View project directory structure [project directory parent directory execution]
tree -L 2 -F gowireshark
```
</details>

<details>
<summary>2.Compile the libpcap dynamic link library</summary>

```
cd /opt
export PCAPV=1.10.1
wget http://www.tcpdump.org/release/libpcap-$PCAPV.tar.gz
tar -zxvf libpcap-$PCAPV.tar.gz
cd libpcap-$PCAPV
export CC=aarch64-linux-gnu-gcc
./configure --host=aarch64-linux --with-pcap=linux
# Remember to install the flex、bison library and remove the extra manifest and syso files
make

# If there is no bison library, please install it
apt install bison

# After the compilation is completed, modify 【libpcap.so.1.10.1】 to 【libpcap.so.1】, 
# you can call the dynamic link library in the go code, and the required operations are:

// Importing the libpcap library will find a dynamic link library named libpcap.so.1 in the libs directory
#cgo LDFLAGS: -L${SRCDIR}/libs -lpcap
#cgo LDFLAGS: -Wl,-rpath,${SRCDIR}/libs
// This allows the program to find the source code corresponding to the libpcap dynamic link library
#cgo CFLAGS: -I${SRCDIR}/include/libpcap
// Comment out the c99 standard(if any), otherwise you will not recognize the u_int, u_short and other types when calling libpcap
//#cgo CFLAGS: -std=c99
```
</details>

## 3. Develop

---
   
1. First write the new function C code, you can create a new C file in lib.c or the root directory.
2. Synchronously update the function declaration to the header file lib.h with the same name or create a new header file, and also add the same declaration to the go code preamble.
3. Encapsulate external interfaces in GO code.
4. Tests are written to the tests/ directory.
5. Use the clang-format tool to format custom C code and header files:
   E.g：`clang-format -i lib.c`，With the parameter '-i' indicates that this command directly formats the specified file, remove '-i' to preview.
   Modify all .c files in the root directory and all .h header files in the include/ directory (only the current directory is level 1, do not traverse down to find it):
   
   ```shell
   find . -maxdepth 1 -name '*.c' | grep -v 'cJSON.c' | xargs  clang-format -i
   find ./include -maxdepth 1 -name '*.h' | grep -v 'cJSON.h' | xargs  clang-format -i
   ```
6. how to test(cd tests/):
   ```shell
   # Parse and output the first frame
   go test -v -run TestDissectPrintFirstFrame
   # Parse and output a frame in JSON format
   go test -v -run TestGetSpecificFrameProtoTreeInJson
   # Parses and outputs a frame of HEX data
   go test -v -run TestGetSpecificFrameHexData
   # Parse packets in real time
   go test -v -run TestDissectPktLive
   # Real-time packet capture Read a certain number and parse it
   go test -v -run TestDissectPktLiveSpecificNum
   ```

## 4. TODO

---
1. ~~Offline packet file parsing printing~~
2. ~~Offline packet files parse and output JSON format~~
3. ~~Base 16 data acquisition~~
4. ~~Listen to interfaces in real time and capture packets~~
5. ~~Parse packets caught from the interface in real time~~
6. ~~Encapsulates the logic for go to invoke real-time parsing - transmits real-time parsing results to golang via Unix domain sockets (AF_UNIX)~~
7. ~~Encapsulates Golang's processing of the received real-time packet parsing results for Golang calling~~
8. ~~Optimize code to resolve memory leaks~~
9. ~~Stop real-time packet capture parsing~~
10. Optimize memory leakage and improve the performance of real-time packet capture and parsing interfaces
11. Support real-time capture of multiple devices, and can locate the handle according to the device name and close
